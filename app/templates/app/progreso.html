{% extends "base.html" %}
{% block content %}
<h1 style="margin-top: 15rem">Registro de Peso Diario</h1>

<!-- Formulario para añadir peso -->
<form id="pesoForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Registrar Peso</button>
</form>

<!-- Contenedor para el calendario -->
<div id="calendar" style="margin-top: 20px;"></div>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar el calendario
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',  // Vista inicial del calendario (mes)
            events: '/InForFit/peso-data/',  // Endpoint para obtener los datos
            eventColor: '#ff9f89',  // Color de fondo del evento
            eventTextColor: '#000000',  // Color del texto del evento
            eventDisplay: 'block',  // Mostrar los eventos
        });

        calendar.render();  // Renderizar el calendario

        // Manejar el envío del formulario de peso
        document.getElementById('pesoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);  // Obtener los datos del formulario

            // Enviar los datos del formulario mediante Fetch
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),  // Incluir el token CSRF
                },
                body: formData,  // Enviar los datos como FormData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('Peso registrado con éxito');
                    calendar.refetchEvents();  // Recargar los eventos en el calendario
                } else {
                    alert('Error al registrar peso');
                    console.log(data.errors);
                }
            })
            .catch(error => {
                alert('Hubo un error al procesar la solicitud.');
                console.error(error);
            });
        });
    });
</script>

{% endblock %}
