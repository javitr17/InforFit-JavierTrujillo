<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro</title>
    <link rel="stylesheet" href="{% static 'css/estilosBase.css' %}">
    <link rel="stylesheet" href="{% static 'css/estilosRegistroDatos.css' %}">
    <link rel="stylesheet" href="{% static 'css/estilosRegistroPlanes.css' %}">
    <link rel="stylesheet" href="{% static 'css/estilosRegistroPago.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
      

        .centrarFormularioStripe {
            display: grid;
            grid-template-columns: 5% 90% 5%;
        }

        

        #card-errors {
            color: red;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="registroCabecera">
        <a href="{% url 'welcome' %}"><img src="{% static 'imagenes/logo.png' %}" alt="Logo"></a>
        <div></div>
        <div class="registroNavDer3">
            <div class="registroNum3">1</div>
            <div class="registroNum3">2</div>
            <div class="registroNum3">3<div class="registroSubrayado"></div></div>
        </div>
    </div>

    <div class="fondoRegistro1">
        <div class="registroSeccionIzq1">
            <div class="registroPlanSeccion2">
                <div class="registroPlanContenido2">
                    <i class="fa-solid fa-check"></i>
                    <div>
                        <div class="registroPlanContenido2titulo">PLAN</div>
                        <div class="registroPlanContenido2texto">{{ contrato }} - {{ cuota_mensual }} /mes</div>
                    </div>
                    <a href="{% url 'signupPlan' %}">Editar</a>
                </div>
            </div>

            <div class="registroDatosSeccion3">
                <i class="fa-solid fa-check"></i>
                <div>
                    <div class="registroDatosSeccion3titulo">TUS DATOS</div>
                    <div class="registroDatosSeccion3texto">{{ nombre }} {{ apellidos }}</div>
                </div>
                <a href="{% url 'signupDatos' %}?contrato={{ contrato }}">Editar</a>
            </div>

            <div class="registroDetallesPagoSeccion3">
                <div class="registroDetallesPago">DETALLES DE PAGO</div>
                <div class="centrarFormularioStripe">
                    <div></div>
                    <form id="payment-form">
                        {% csrf_token %}
                        <!-- Campo para el titular de la tarjeta -->
                        <div class="form-group">
                            <input type="text" id="card-holder-name" name="card_holder_name" placeholder="Titular tarjeta" required>
                        </div>
                        <!-- Campo de Stripe -->
                        <div id="card-element" class="stripe-input"></div>
                        <div id="card-errors" role="alert"></div>
                    </form>
                    <div></div>
                </div>    
            </div>

            {% if mensaje %}
                <div class="overlay">
                    <div class="message-container">
                        {% if mensaje == 'success' %}
                            <p>Pago realizado con éxito. Ya puedes disfrutar de las multiples ventajas de la suscripción. ¡Gracias por confiar en nosotros!</p>
                            <div class="payment-details">
                                <div class="registroMessageTexto">
                                    <div>Cuota Mensual:</div><div>{{ cuota_mensual }}</div>
                                </div>
                                <div class="registroMessageTexto">
                                    <div>Cuota Inscripción:</div><div> {{ cuota_inscripcion }}</div>
                                </div>
                                <div class="registroMessageTexto">
                                    <div>Total Pagado:</div> <div>{{ monto_total }}</div>
                                </div>
                            </div>
                            <div class="registroMensajeBoton"><a href="{% url 'welcome' %}">PAGINA PRINCIPAL</a></div>
                        {% elif mensaje == 'cancel' %}
                            <p>Error en el pago. Por favor, verifica los datos e inténtalo de nuevo.</p>
                            <div class="registroMensajeBoton"><a href="{% url 'signupPago' %}?contrato={{ contrato }}">VOLVER</a></div>
                        {% elif mensaje == 'usuario_existente' %}
                            <p>Ya hay un usuario existente para los datos que has introducido. Por favor, verifica que sean correctos.</p>
                            <div class="registroMensajeBoton"><a href="{% url 'signupDatos' %}?contrato={{ contrato }}">IR A DATOS</a></div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="registroSeccionDer2">
            <div class="registroSeccionDer1Contenedor">
                <div class="registroInformacionGeneral">INFORMACIÓN GENERAL</div>
                <div class="registroPlanDetalles2">
                    <div class="registroPlanDetalle">
                        <div class="registroTexto">Contrato</div>
                        <div class="registroValor">{{ contrato }}</div>
                    </div>
                    <div class="registroPlanDetalle">
                        <div class="registroTexto">Duración:</div>
                        <div class="registroValor">{{ duracion }}</div>
                    </div>
                    <div class="registroPlanDetalle">
                        <div class="registroTexto">Cuota de inscripción:</div>
                        <div class="registroValor">{{ cuota_inscripcion }}</div>
                    </div>
                    <div class="registroPlanDetalle">
                        <div class="registroTexto">Renovación:</div>
                        <div class="registroValor">{{ renovacion }}</div>
                    </div>
                    <div class="registroPlanDetalle">
                        <div class="registroTexto">Recisión:</div>
                        <div class="registroValor">{{ recision }}</div>
                    </div>
                    <div class="registroCuotaMensual">
                        <div class="registroCuotaMensualTexto">Cuota mensual</div>
                        <div class="registroCuotaMensualValor">{{ cuota_mensual }}</div>
                    </div>
                     <div class="registroTotalAPagar">
                        <div class="registroTotalAPagarTexto">TOTAL A PAGAR</div>
                        <div class="registroTotalAPagarValor">{{ total_pagar }}</div>
                    </div>
                </div>
                <div class="registroBoton2" id="boton-pagar" style="pointer-events: none; opacity: 0.5;">
                    <a href="javascript:void(0);">PAGAR AHORA</a>
                </div>
            </div>
        </div>
    </div>
   

    <script src="https://js.stripe.com/v3/"></script>
    <script>
   document.addEventListener("DOMContentLoaded", function () {
    var stripe = Stripe("{{ stripe_public_key }}");
    var elements = stripe.elements();
    var cardElement = elements.create("card");
    cardElement.mount("#card-element");

    var submitButton = document.getElementById("boton-pagar");
    var enlacePagarAhora = document.querySelector(".registroBoton2 a");

    // Crear overlay y spinner para la animación de carga
    var overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.backgroundColor = "rgba(34, 46, 57, 0.9)"; // Fondo #222E39 con opacidad del 90%
    overlay.style.display = "none";
    overlay.style.zIndex = "9999";
    overlay.style.justifyContent = "center";
    overlay.style.alignItems = "center";

    var spinner = document.createElement("div");
    spinner.style.width = "50px";
    spinner.style.height = "50px";
    spinner.style.border = "5px solid #f3f3f3";
    spinner.style.borderTop = "5px solid #3498db";
    spinner.style.borderRadius = "50%";
    spinner.style.animation = "spin 1s linear infinite";
    overlay.appendChild(spinner);
    document.body.appendChild(overlay);

    // Agregar la animación de carga al hacer clic en "Pagar Ahora"
    cardElement.on("change", function (event) {
        if (event.complete) {
            document.getElementById("card-errors").textContent = "";
            enlacePagarAhora.style.pointerEvents = "auto";
            enlacePagarAhora.style.opacity = "1";
            enlacePagarAhora.style.cursor = "pointer";
            submitButton.style.opacity = "1";
        } else if (event.error) {
            document.getElementById("card-errors").textContent = event.error.message;
        }
    });

    submitButton.querySelector("a").addEventListener("click", function (event) {
        event.preventDefault();

        var cardHolderName = document.getElementById("card-holder-name").value;
        if (!cardHolderName.trim()) {
            document.getElementById("card-errors").textContent = "Por favor, ingresa el nombre del titular de la tarjeta.";
            return;
        }

        // Mostrar overlay con spinner
        overlay.style.display = "flex";

        stripe.createPaymentMethod({
            type: "card",
            card: cardElement,
            billing_details: { name: cardHolderName },
        }).then(function (result) {
            if (result.error) {
                document.getElementById("card-errors").textContent = result.error.message;
                overlay.style.display = "none"; // Ocultar overlay en caso de error
            } else {
                fetch("{% url 'signupPago' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({
                        payment_method_id: result.paymentMethod.id,
                        card_holder_name: cardHolderName, // Enviar el nombre del titular
                        monto_total: {{ monto_total }},
                        contrato: "{{ contrato }}",
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    overlay.style.display = "none"; // Ocultar overlay después de recibir respuesta
                    if (data.usuario_existente) {
                        window.location.href = "{% url 'signupPago' %}?contrato={{ contrato }}&mensaje=usuario_existente";
                    } else if (data.status === "success") {
                        window.location.href = "{% url 'signupPago' %}?contrato={{ contrato }}&mensaje=success";
                    } else {
                        window.location.href = "{% url 'signupPago' %}?contrato={{ contrato }}&mensaje=cancel";
                    }
                })
                .catch(error => {
                    console.error("Error al procesar el pago:", error);
                    overlay.style.display = "none"; // Ocultar overlay si ocurre un error
                });
            }
        });
    });
});

// CSS para el spinner (en forma de animación CSS)
var style = document.createElement("style");
style.type = "text/css";
style.innerHTML = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>
